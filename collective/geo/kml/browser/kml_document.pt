<?xml version="1.0" encoding="utf-8"?>
<kml
  xmlns="http://www.opengis.net/kml/2.2"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:atom="http://www.w3.org/2005/Atom">
  <tal:headers
    condition="python:request and request.response.setHeader(
                'Content-Type', 'application/vnd.google-earth.kml+xml;charset=utf-8')"
    />
  <Document tal:define="site_properties context/portal_properties/site_properties;
                        use_view_action site_properties/typesUseViewActionInListings|python:();">

    <tal:defaultstyle define="styleid string:defaultStyle;
                              pointmarkersize view/pointmarkersize;
                              pointmarker view/pointmarker;
                              linecolor view/linecolor;
                              linewidth view/linewidth;
                              polygoncolor view/polygoncolor">
          <metal:macro use-macro="context/@@kmldocument-macros/kmlstyle" />
    </tal:defaultstyle>

    <name tal:content="context/title">TITLE</name>
    <visibility>1</visibility>
    <open>0</open>

    <tal:features tal:repeat="feature view/features">
      <Folder tal:condition="exists:feature/features">
        <name tal:content="feature/name">TITLE</name>
        <description tal:content="feature/description">DESCRIPTION</description>
        <tal:placemarks repeat="placemark feature/features">
          <Placemark
              tal:define="item_object placemark/dc;
                          item_type item_object/portal_type;
                          item_url item_object/absolute_url;
                          item_view_url python:(item_type in use_view_action and item_url+'/view') or item_url;
                          custom_style feature/geom/style;
                          use_custom_style python:custom_style and custom_style['use_custom_style'];">
              <name tal:content="placemark/name">TITLE</name>
              <atom:author>
                 <atom:name tal:content="placemark/author/name">Author name</atom:name>
              </atom:author>
              <atom:link href="link to the content"
                         tal:attributes="href placemark/alternate_link"/>
              <description>
                <span tal:replace="structure string:&lt;![CDATA[" />
                <div>
                  <a href="#" tal:attributes="href item_view_url;"
                     tal:condition="item_object/image|nothing">
                    <img src="" alt=""
                         tal:replace="structure python: path('nocall:item_object/tag')(scale='thumb', css_class='tileImage')" />
                  </a>
                  <p tal:content="placemark/description" tal:omit-tag="not:placemark/description">ITEM DESCRIPTION</p>
                  <p>
                    <strong>URL:</strong> 
                    <a tal:attributes="href item_view_url">Item URL</a>
                  </p>
                  <p><strong>Type:</strong> <span tal:content="item_type">Document</span></p>
                  <p><strong>Last Modified:</strong> <span tal:content="python:context.toLocalizedTime(item_object.modification_date, long_format=1)">01 January 2010</span></p>
                  <p><strong>Creation Date:</strong> <span tal:content="python:context.toLocalizedTime(item_object.creation_date, long_format=1)">1 January 2010</span></p>
                </div>

                <span tal:replace="structure string:]]&gt;" />
              </description>

              <styleUrl tal:condition="not:use_custom_style">#defaultStyle</styleUrl>
              <tal:customstyle tal:condition="use_custom_style"
                       define="styleid nothing;
                               pointmarkersize python:placemark.hasPoint and custom_style['marker_image_size'] or None;
                               pointmarker python:placemark.hasPoint and custom_style['marker_image'] or None;
                               linecolor python:placemark.hasLineString and custom_style['linecolor'] or None;
                               linewidth python:placemark.hasLineString and custom_style['linewidth'] or None;
                               polygoncolor python: placemark.hasPolygon and custom_style['polygoncolor'] or None">
                    <metal:macro use-macro="context/@@kmldocument-macros/kmlstyle" />
              </tal:customstyle>

              <Point tal:condition="placemark/hasPoint">
                <coordinates tal:content="placemark/coords_kml">
                  COORDINATE LIST
                </coordinates>
              </Point>
              <LineString tal:condition="placemark/hasLineString">
                <coordinates tal:content="placemark/coords_kml">
                  COORDINATE LIST
                </coordinates>
              </LineString>
              <Polygon tal:condition="placemark/hasPolygon">
              <outerBoundaryIs>
                <LinearRing>
                  <coordinates tal:content="placemark/coords_kml">
                    COORDINATE LIST
                  </coordinates>
                </LinearRing>
              </outerBoundaryIs>
              </Polygon>
          </Placemark>
        </tal:placemarks>
      </Folder>

      <Placemark tal:condition="not:exists:feature/features"
                 tal:define="item_object python:feature.dc;
                             item_type item_object/portal_type;
                             item_url item_object/absolute_url;
                             item_view_url python:(item_type in use_view_action and item_url+'/view') or item_url;
                             custom_style feature/geom/style | nothing;
                             use_custom_style python:custom_style and custom_style['use_custom_style']">
        <name>
          <span tal:replace="structure string:&lt;![CDATA[" />
          <a href="#" tal:attributes="href item_view_url;" tal:content="feature/name">TITLE</a> 
          <span tal:replace="structure string:]]&gt;" />
        </name>
        <atom:author>
          <atom:name tal:content="feature/author/name">Author name</atom:name>
        </atom:author>
        <atom:link href="link to the content"
               tal:attributes="href feature/alternate_link"/>
        <description>
          <span tal:replace="structure string:&lt;![CDATA[" />
          <div>
          <a href="#" tal:attributes="href item_view_url;"
                     tal:condition="item_object/image|nothing">
               <img src="" alt=""
                           tal:replace="structure python: path('nocall:item_object/tag')(scale='thumb', css_class='tileImage')" />
          </a>
          <p tal:content="feature/description" tal:omit-tag="not:feature/description">ITEM DESCRIPTION</p>
          <dl>
          <tal:properties tal:repeat="property python:view.display_properties(item_object)">
            <dt tal:content="property/title">Display Title</dt>
            <dd tal:content="property/content">Content</dd>
          </tal:properties>
          </dl>
          </div>
          <span tal:replace="structure string:]]&gt;" />
        </description>

        <styleUrl tal:condition="python:not use_custom_style">#defaultStyle</styleUrl>
        <tal:customstyle condition="python:use_custom_style">
          <tal:properties define="styleid nothing;
                                  pointmarkersize python:feature.hasPoint and custom_style['marker_image_size'] or None;
                                  pointmarker python:feature.hasPoint and custom_style['marker_image'] or None;
                                  linecolor python:feature.hasLineString and custom_style['linecolor'] or None;
                                  linewidth python:feature.hasLineString and custom_style['linewidth'] or None;
                                  polygoncolor python:feature.hasPolygon and custom_style['polygoncolor'] or None">
              <metal:macro use-macro="context/@@kmldocument-macros/kmlstyle" />
          </tal:properties>
        </tal:customstyle>

        <Point tal:condition="feature/hasPoint">
          <coordinates tal:content="feature/coords_kml">COORDINATE LIST</coordinates>
        </Point>
        <LineString tal:condition="feature/hasLineString">
          <coordinates tal:content="feature/coords_kml">COORDINATE LIST</coordinates>
        </LineString>
        <Polygon tal:condition="feature/hasPolygon">
          <outerBoundaryIs>
            <LinearRing>
              <coordinates tal:content="feature/coords_kml">COORDINATE LIST</coordinates>
            </LinearRing>
          </outerBoundaryIs>
        </Polygon>
      </Placemark>
    </tal:features>
  </Document>
</kml>
